<!DOCTYPE html>
<html lang="en">


<head>
<meta charset="utf-8">
<title>Soccer Viz</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script type="text/javascript" src="d3/d3.js"></script>
<script type="text/javascript" src="dist/metricsgraphics.js"></script>
<link rel="stylesheet" type="text/css" href="dist/metricsgraphics.css">
<style>
body {
font: 11px sans-serif;
}

.axis path,
.axis line {
fill: none;
stroke: #000;
	shape-rendering: crispEdges;
}

.dot {
stroke: #fff;
}


.tooltip {
position: absolute;
width: 200px;
height: 28px;
pointer-events: none;
}

</style>
<!--Set up area for both of the graphs -->


<body>
<!-- Selection for the Statistics Graph-->
<div style="display: table-cell; width: 120;position:absolute;left:2%;">
<label for="xdropdownStat">X: </label>
<select id="xdropdownStat">
	<option value="ga">Goals Against</option>
	<option value="gf">Goals For</option>
	<option value="gd">Goal Differential</option>
	<option value="points">Points</option>
</select>
</div>
<div style="display: table-cell; width: 150;position:absolute;left:8%;">
<label for="ydropdownStat">Y: </label><select id="ydropdownStat">
<option value="revenue">Revenue</option>
<option value="position">Position</option>

</select>
</div>
<!-- <div style="display: table-cell; width: 150;">
<button id="updateStat" onclick="updateClickedStat()">Update</button>
</div> -->
</div>



<!--Selection for the Social media Graph -->
<div style="display: table-cell; width: 120; position:absolute; right:40%;">
<label for="xdropdownSocial">X: </label>
<select id="xdropdownSocial">
	<option value="twitter">Twitter Followers</option>
	<option value="facebook">Facebook Followers</option>
</select>
</div>
<!-- <div style="display: table-cell; width: 150;">
<label for="ydropdownSocial">Y: </label>
<select id="ydropdownSocial">
	<option value="revenue">Revenue</option>
	<option value="position">Position</option>
</select>
</div>  -->
<!-- <div style="display: table-cell; width: 150;">
<button id="updateSocial" onclick="updateClickedSocial()">Update</button>
</div> -->
</div>

<!-- Year Selector-->

<div style="display: table-cell; width: 120;position:absolute;right:59%;">
<label for="yearDropDown">Year: </label>
<select id="yearDropDown" onchange="">
	<option value="2014">2014</option>
	<option value="2013">2013</option>
	<option value="2012">2012</option>
	<option value="2011">2011</option>
	<option value="2010">2010</option>
	<option value="2009">2009</option>
	<option value="2008">2008</option>
	<option value="2007">2007</option>
	<option value="2006">2006</option>
	<option value="2005">2005</option>
</select>
<div style="display: table-cell; width: 120;">
<!-- <button id="updateYear" onclick="updateYear()">Update</button> -->
</div>
</div>
<script src="http://d3js.org/d3.v3.min.js"></script>

<!-- Setup Chart areas-->
<div style="width: 100%; display: table;">
    <div style="display: table-row">
        <div id= "statArea" style=" display: table-cell;">  </div>
        <div id= "socialArea" style="display: table-cell;"> </div>
    </div>
</div>



<script>

//set the margins for the canvas 
var margin = {top: 20, right: 20, bottom: 30, left: 40},
width = 750 - margin.left - margin.right,
height = 500 - margin.top - margin.bottom;

//Create the label and scale holders for the Stat and Social graph 
var year= "2014";
var	XLabelStat;
var YLabelStat;
var XScaleStat;
var YScaleStat;
var	XLabelSocial;
var YLabelSocial;
var XScaleSocial;
var YScaleSocial;
//can use these to access the data 
var twitterArr=[];
var facebookArr=[];
var revenueArr=[];
var positionArr=[];
var teamNames=[]
var countries=[];
var gfArr=[];
var gaArr=[];
var gdArr=[];
var pointsArr=[];

var selectedTeams = [];
var gaVRevenue = [];



function getScatterplotData(data,x,y) {
	var year = document.getElementById('yearDropDown').value;

	var scatterData = [];
	var j;
	for (j = 0; j < data[''+year].length; j++) {
		scatterData[j] = {};

		scatterData[j][x] = parseInt(data[''+year][j].stats[x]);
		scatterData[j][y] = parseFloat(data[''+year][j][y]);

		scatterData[j]['country'] = data[''+year][j].country;
		scatterData[j]['team'] = data[''+year][j].name;
		scatterData[j]['twitter'] = data[''+year][j].twitter;
		scatterData[j]['facebook'] = data[''+year][j].facebook;
	}
	// console.log(year);
	if (parseInt(year) > 2012) {
		$('#socialAreaSVG').remove();
		var social = document.getElementById('#socialAreaSVG');
		if (social == null) {
			console.log(social);
			d3.select('#socialArea').append('svg')
				.attr('id','socialAreaSVG')
				.attr("width", (width + margin.left + margin.right))
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		}
		console.log('year greater than 2012');
		updateSocialGraph(data);
	}
	if (parseInt(year) < 2013) {
		// console.log('year less than 2013');
		// console.log($('socialAreaSVG'));
		$('#socialAreaSVG').remove();
	}


	return scatterData;
}

function updateScatterplot(json) {
	var x = document.getElementById('xdropdownStat').value;
	var y = document.getElementById('ydropdownStat').value;

	
	var data = getScatterplotData(json,x,y);
	// updateSocialGraph(json);
	//console.log(data);
	var colorRange = 
		['red','blue','black','green','violet','brown','orange'],
		colorDomain =
		['Spain','England','Germany','France','Italy',
		'Turkey','Scotland'];

		if (y == 'revenue') {
			console.log('y is revenue');
		}
	MG.data_graphic({
        title: "European Teams",
        data: data,
        chart_type: 'point',
        width: 600,
        height: 500,
        left: 150,
        right: 20,
        bottom: 70,
        target: '#statsAreaSVG',
        xax_format: function(f) {
            var pf = d3.formatPrefix(f);
            return Math.round(pf.scale(f)) + pf.symbol;
        },
        x_accessor: x,
        y_accessor: y,
        yax_units: y == 'revenue' ? '€' : '',
        color_accessor: 'country',
        color_domain: colorDomain,
        color_type:'category',
        color_range: colorRange,
        point_size: 4.5,
        x_label: x,
        y_label: y,
        linked: true,
        mouseover: function(d, i) { 
        	console.log(d,i);
        	var graph = document.getElementById('statArea').getBoundingClientRect();
        	// console.log(graph.top,graph.bottom,graph.left,graph.right);
        	var point = d.point;
        	var year = document.getElementById('yearDropDown').value;
        	if (parseInt(year) > 2012) {
        		tooltip.style('right', (graph.right + 400)+'px')
        		.style('top', (graph.top + 280)+'px')
        	}
        	else {
        		console.log(graph.top,graph.bottom,graph.left,graph.right);
        		tooltip.style('left', (graph.left + 600)+'px')
        		.style('top', (graph.top + 280)+'px')	
        	}
        	tooltip.transition()
        		.duration(200)
        		.style('opacity', .9)
        	tooltip.html('<b>Team:</b> '+point.team+'<br/>'+'<b>Country:</b> '+
        		point.country)
        	.style('line-height', '150%');
         },
         mouseout: function() {
         	tooltip.transition()
         		.duration(500)
         		.style('opacity', 0);
         },
        y_rug: true,

    });
}

function getSocialData(data,x,y) {
	
	var year = document.getElementById('yearDropDown').value;

	var socialData = [];
	var i;
	for (var i = 0; i < data[''+year].length; i++) {
		socialData[i] = {};
		// Twitter or Facebook Followers
		socialData[i][x] = parseFloat(data[''+year][i][x]);
		// Revenue or Position	
		socialData[i][y] = parseFloat(data[''+year][i][y]);
		socialData[i]['ga'] = parseInt(data[''+year][i].stats.ga);
		socialData[i]['gf'] = parseInt(data[''+year][i].stats.gf);
		socialData[i]['gd'] = parseInt(data[''+year][i].stats.gd);
		socialData[i]['points'] = parseInt(data[''+year][i].stats.points);
		socialData[i]['country'] = data[''+year][i].country;
		socialData[i]['team'] = data[''+year][i].name;
	}

	// console.log(socialData);
	return socialData;
}

function updateSocialGraph(json) {
	var x = document.getElementById('xdropdownSocial').value;
	// Y is same for scatterplot and social graph
	var y = document.getElementById('ydropdownStat').value;


	var data = getSocialData(json,x,y);

	var colorRange = 
		['red','blue','black','green','violet','brown','orange'],
		colorDomain =
		['Spain','England','Germany','France','Italy',
		'Turkey','Scotland'];


	MG.data_graphic({
        title: "Social Media Graph",
        data: data,
        chart_type: 'point',
        width: 700,
        height: 500,
        left: 150,
        right: 10,
        bottom: 70,
        target: '#socialAreaSVG',
        xax_format: function(f) {
            var pf = d3.formatPrefix(f);
            return Math.round(pf.scale(f)) + pf.symbol;
        },
        x_accessor: x,
        y_accessor: y,
        color_accessor: 'country',
        color_domain: colorDomain,
        color_type:'category',
        color_range: colorRange,
        point_size: 4.5,
        x_label: x += ' Followers',
        y_label: y,
        yax_units: y == 'revenue' ? '€' : '',
        linked: true,
        mouseover: function(d, i) { console.log(d,i); },
        y_rug: true,

    });
}




//Convert the umerical dat within our json 
function getSoccerData(year,data){

	for(i=0;i<data[year].length;i++){
		data[year][i].facebook=+ data[year][i].facebook;
		data[year][i].twitter=+ data[year][i].twitter;
		data[year][i].revenue=+data[year][i].revenue;
		data[year][i].position=+data[year][i].position;
		teamNames.push(data[year][i].name);
		countries.push(data[year][i].country);
		positionArr.push(data[year][i].position);
		twitterArr.push(data[year][i].twitter);
		revenueArr.push(data[year][i].revenue);
		facebookArr.push(data[year][i].facebook);
		gfArr.push(data[year][i]["stats"].gf);
		gaArr.push(data[year][i]["stats"].ga);
		gdArr.push(data[year][i]["stats"].gd);
		pointsArr.push(data[year][i]["stats"].points);
	}
		
}

function extractTeams(data) {
	// console.log(data);
	var i,j,
		teams = [];
	for (i = 2005; i < 2015; i++) {
		// console.log(data[""+i][0]);
		for (var j = 0; j < data[""+i].length; j++) {
			// console.log(data[""+i][j].name);
			if (teams.indexOf(data[""+i][j].name) < 0) {
				teams.push(data[""+i][j].name);
			}
		}
	}
	console.log(teams);
	teamNames = teams;
	return teams;
}

// Markers for Timeline graph.
var markers = [
		{'year':2006, 'label': 'World Cup'},
		{'year':2010, 'label': 'World Cup'},
		{'year':2014, 'label': 'World Cup'}
];

// Store timeline JSON locally after call to D3.json
var timelineData = {};

d3.json("TeamPositions2.json", function(data){
	timelineData = data;
	
	// Timeline Container to hold timeline and legend.
	d3.select("body").append("div").attr('id','timelineContainter')
		// Timeline graph
		.append('div').attr("id", "timeline")
		.attr("style", "width:500px;");

	// Timeline legend
	d3.select('#timelineContainter').append('div')
		.attr('id', 'timelineLegend')
		.attr('style','position:absolute;left:5%;');
	
	// Timeline Example Button 1 
	d3.select('body').append('div').attr('id','timelineButtons')
		.append('input')
		.attr('type', 'button')
		.attr('name', 'chelseaButton')
		.attr('value', 'Chelsea')
		.on('click', function() {
			
			updateTimeline(['Chelsea']);
		});
	// Timeline Example Button 2
	d3.select('#timelineButtons')
		.append('input')
		.attr('type', 'button')
		.attr('name', 'madridButton')
		.attr('value', 'Real Madrid')
		.on('click', function() {
			updateTimeline(['Chelsea',
							'Real Madrid'
							]);
		});
	// Timeline Example Button 3
	d3.select('#timelineButtons').append('input')
		.attr('type', 'button')
		.attr('name', 'romaButton')
		.attr('value', 'AS Roma')
		.on('click', function() {
			updateTimeline(['Chelsea',
							'Real Madrid',
							'AS Roma',
							'Manchester United',
							'Liverpool'
							]);
		});
	d3.select('#timelineButtons').
		attr('style','margin-top:8px;position:absolute;bottom:6%;left:5%');
	
	MG.data_graphic({
	    title: 'League Positions Over Time',
	    // description: 'This is where a teams position over time will appear.',
	    data: data["Chelsea"], 
	    markers: markers,
	    width: 1000,
	    height: 250,
	    left: 150,
	    right: 40,
	    bottom: 70,
	    area: false,
	    x_label: 'Season',
	    y_label: 'Position',
	    interpolate: 'basic',
	    target: '#timeline', // the html element that the graphic is inserted in
	    x_accessor: 'year',  // the key that accesses the x value
	    y_accessor: 'position', // the key that accesses the y value
	    legend: ['Chelsea'],
	    legend_target: '#timelineLegend'
	});	
});


function updateRevenue(data) {
	var i,j;
	for(i = 2005; i < 2015; i++) {
		j = 0;
		for (var j = 0; j < data[i].length; j++) {
			data[i][j].revenue *= 1000000;
		};
	}
	// console.log(data);
}

d3.json("SoccerData.json", function(error, data) {
	// getSoccerData(year,data);
	// drawStat(data);	
	// getGaVRevenue(data,2014);
	// console.log(gaVRevenue);
	updateRevenue(data);
	updateScatterplot(data);

	d3.select('#statArea').append('div')
		.attr('id', 'statsAreaLegend');

	$('#xdropdownStat').change(function() {
		updateScatterplot(data);
	});
	$('#ydropdownStat').change(function() {
		updateScatterplot(data);
	});
	$('#yearDropDown').change(function() {
		updateScatterplot(data);
	});
	$('#xdropdownSocial').change(function() {
		updateSocialGraph(data);
	});
});


/**
 * Graphs a timeline (position vs. time) given an array of team names.
 * @param {Array} team An array containing team names.
 */
function updateTimeline(teams) {
	// console.log(teams);
	var data = [];
	for (var i = 0; i < teams.length; i++) {
		data.push(timelineData[teams[i]]);
	};
	
	MG.data_graphic({
	    title: 'League Positions Over Time',
	    // description: 'This is where a teams position over time will appear.',
	    data: data, 
	    markers: markers,
	    width: 1000,
	    height: 250,
	    left: 150,
	    right: 40,
	    bottom: 70,
	    x_label: 'Season',
	    y_label: 'Position',
	    interpolate: 'basic',
	    target: '#timeline', // the html element that the graphic is inserted in
	    x_accessor: 'year',  // the key that accesses the x value
	    y_accessor: 'position', // the key that accesses the y value
	    legend: teams,
	    legend_target: '#timelineLegend',

	});
}


//Set the variables to determine if the stats and social media graph have been drawn
var alreadyDrawnStats = false;
var alreadyDrawSocial= false;

// setup fill color
var cValueSocial = function(d) { return d.name;},
color = d3.scale.category20();
var cValueStat = function(d) { return d.name;},
color = d3.scale.category20();

//connect the svg elements to both the stat chart and the social revenue chart 
var statChart = d3.select("#statArea").append("svg")
.attr("width", (width + margin.left + margin.right))
.attr("height", height + margin.top + margin.bottom)
.attr('id','statsAreaSVG')
.append("g")
.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// var socialChart = d3.select("#socialArea").append("svg")
// .attr('id', 'socialAreaSVG')
// .attr("width", width + margin.left + margin.right)
// .attr("height", height + margin.top + margin.bottom)
// .append("g")
// .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//add the tool tip which we will use for the hoover effect for both charts 
var tooltip = d3.select("body").append("div")
.attr("class", "tooltip")
.style("opacity", 0);

// Returns the selected option in the X-axis dropdown for the stat chart. 
function getXSelectedOptionStat(){
	var node = d3.select('#xdropdownStat').node();
	var i = node.selectedIndex;
	return node[i].value;
}

// Returns the selected option in the Y-axis dropdown for the stat chart . 
function getYSelectedOptionStat(){
	var node = d3.select('#ydropdownStat').node();
	var i = node.selectedIndex;
	return node[i].value;
}	

// Returns the selected option in the X-axis dropdown for the social chart. 
function getXSelectedOptionSocial(){
	var node = d3.select('#xdropdownSocial').node();
	var i = node.selectedIndex;
	return node[i].value;
}

// Returns the selected option in the Y-axis dropdown for the social chart . 
function getYSelectedOptionSocial(){
	var node = d3.select('#ydropdownSocial').node();
	var i = node.selectedIndex;
	return node[i].value;
}	

// Returns the selected option in the dropdown for the year. 
function getYear(){
	var node = d3.select('#yearDropDown').node();
	var i = node.selectedIndex;
	return node[i].value;
}	
function updateYear(){
year= getYear();
console.log(year);
}
function drawStat(data){
	//setup x 
	var xValue = function(d) { return d[XLabelsStat];}, // data -> value
	xScale = d3.scale.linear().range([0, width]), // value -> display
	xMap = function(d) { return xScale(xValue(d));}, // data -> display
	xAxis = d3.svg.axis().scale(xScale).orient("bottom");

	// setup y
	var yValue = function(d) { return d[YLabelStat];}, // data -> value
	yScale = d3.scale.linear().range([height, 0]), // value -> display
	yMap = function(d) { return yScale(yValue(d));}, // data -> display
	yAxis = d3.svg.axis().scale(yScale).orient("left");

	xScale.domain([d3.min(data, xValue)-1, d3.max(data, xValue)+1]);
	yScale.domain([d3.min(data, yValue)-1, d3.max(data, yValue)+1]);
	
	// x-axis
	statChart.append("g")
	.attr("class", "x axis")
	.attr("transform", "translate(0," + height + ")")
	.call(xAxis)
	.append("text")
	.attr("class", "label")
	.attr("x", width)
	.attr("y", -6)
	.style("text-anchor", "end")
	.text(XLabelStat);

	// y-axis
	statChart.append("g")
	.attr("class", "y axis")
	.call(yAxis)
	.append("text")
	.attr("class", "label")
	.attr("transform", "rotate(-90)")
	.attr("y", 7)
	.attr("dy", ".71em")
	.style("text-anchor", "end")
	.text(YLabelStat);

}
function drawSocial(data){
	//setup x 
	var xValue = function(d) { return d[XLabelsSocial];}, // data -> value
	xScale = d3.scale.linear().range([0, width]), // value -> display
	xMap = function(d) { return xScale(xValue(d));}, // data -> display
	xAxis = d3.svg.axis().scale(xScale).orient("bottom");

	// setup y
	var yValue = function(d) { return d[YLabelSocial];}, // data -> value
	yScale = d3.scale.linear().range([height, 0]), // value -> display
	yMap = function(d) { return yScale(yValue(d));}, // data -> display
	yAxis = d3.svg.axis().scale(yScale).orient("left");

	xScale.domain([d3.min(data, xValue)-1, d3.max(data, xValue)+1]);
	yScale.domain([d3.min(data, yValue)-1, d3.max(data, yValue)+1]);
	
	// x-axis
	socialChart.append("g")
	.attr("class", "x axis")
	.attr("transform", "translate(0," + height + ")")
	.call(xAxis)
	.append("text")
	.attr("class", "label")
	.attr("x", width)
	.attr("y", -6)
	.style("text-anchor", "end")
	.text(XLabelSocial);

	// y-axis
	socialChart.append("g")
	.attr("class", "y axis")
	.call(yAxis)
	.append("text")
	.attr("class", "label")
	.attr("transform", "rotate(-90)")
	.attr("y", 7)
	.attr("dy", ".71em")
	.style("text-anchor", "end")
	.text(YLabelSocial);

}
/* create the x- axis and y-axis for the stat chart and 
 * upload the information ONCE WE HAVE TIME ASSOCIATED WE WILL NEED TO ADJUST DATA INPUT
 */
function updateClickedStat(){

	if(getXSelectedOptionStat()=='Goals Against' && getYSelectedOptionStat()=='Revenue'){
		XLabelStat ="Goals Against";
		YLabelStat= "Revenue";
	}else if(getXSelectedOptionStat()=='Goals For' && getYSelectedOptionStat()=='Revenue'){
		XLabelStat ="Goals For";
		YLabelStat= "Revenue";
	}else if(getXSelectedOptionStat()=='Goal Differential' && getYSelectedOptionStat()=='Revenue'){
		XLabelStat ="Goal Differential";
		YLabelStat= "Revenue";
	}else if(getXSelectedOptionStat()=='Points' && getYSelectedOptionStat()=='Revenue'){
		XLabelStat ="Points";
		YLabelStat= "Revenue";
	}else if(getXSelectedOptionStat()=='Goals For' && getYSelectedOptionStat()=='Position'){
		XLabelStat ="Goals For";
		YLabelStat= "Position";
	}else if(getXSelectedOptionStat()=='Goal Differential' && getYSelectedOptionStat()=='Position'){
		XLabelStat="Goal Differential";
		YLabelStat= "Position";
	}else if(getXSelectedOptionStat()=='Goals Against' && getYSelectedOptionStat()=='Position'){
		XLabelStat ="Goals Against";
		YLabelStat= "Position";
	}else if(getXSelectedOptionStat()=='Points' && getYSelectedOptionStat()=='Position'){
		XLabelStat ="Points";
		YLabelStat= "Position";
	}
	
	// d3.json("SoccerData.json", function(error, data) {
	// 	getSoccerData(year,data);
	// 	drawStat(data);	
	// 	getGaVRevenue(data,2014);
	// 	// console.log(gaVRevenue);

	// 	d3.select('statArea').append('div')
	// 		.attr('id', 'statsAreaLegend');

		// MG.data_graphic({
	 //        title: "Simple Scatterplot",
	 //        data: gaVRevenue,
	 //        chart_type: 'point',
	 //        width: 600,
	 //        height: 500,
	 //        left: 100,
	 //        right: 10,
	 //        bottom: 70,
	 //        target: '#statsAreaSVG',
	 //        xax_format: function(f) {
	 //            var pf = d3.formatPrefix(f);
	 //            return Math.round(pf.scale(f)) + pf.symbol;
	 //        },
	 //        x_accessor: 'ga',
	 //        y_accessor: 'revenue',
	 //        color_accessor: 'country',
	 //        color_type:'category',
	 //        point_size: 4.5,
	 //        x_label: 'Goals Against',
	 //        y_label: 'Revenue',
	 //        mouseover: function(d, i) { console.log(d,i); },
	 //        y_rug: true,
	 //        legend_target: '#statsAreaLegend',
	 //        legend: ['England', 'France', 'Germany', 'Spain', 'Italy',
	 //        		'Scotland', 'Turkey']
	 //    });
// });
}

function teamListChanged(team) {
	var index = selectedTeams.indexOf(teamList[i]);
	if (input.checked && index < 0) {
		selectedTeams.push(teams[i]);
	}
	else {
		selectedTeams.remove(index)
	}
	updateTimeline(teamList);
}

/* create the x- axis and y-axis for the social chart and 
 * upload the information ONCE WE HAVE TIME ASSOCIATED WE WILL NEED TO ADJUST DATA INPUT
 */
function updateClickedSocial(){

		
	if(getXSelectedOptionSocial()=='Twitter Followers' && getYSelectedOptionSocial()=='Revenue'){
		XLabelSocial ="twitter";
		YLabelSocial= "revenue";
		
		
	}else if(getXSelectedOptionSocial()=='Twitter Followers' && getYSelectedOptionSocial()=='Position'){
		XLabelSocial ="twitter";
		YLabelSocial= "position";
		
		
	}else if(getXSelectedOptionSocial()=='Facebook Followers' && getYSelectedOptionSocial()=='Revenue'){
		XLabelSocial ="facebook";
		YLabelSocial= "revenue";
	
		
	}else{
		XLabelSocial ="facebook";
		YLabelSocial= "position";
		
		
	}
	
		d3.json("SoccerData.json", function(error, data) {
	
		getSoccerData(year,data);
		drawSocial(data);

	});
}

</script>
</body>
</html>